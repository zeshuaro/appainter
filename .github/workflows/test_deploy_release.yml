name: GitHub Actions

on:
  push:
    branches:
      - main
    tags:
      - "v*.*.*"
  pull_request:

env:
  flutter-version: 2.2.3

jobs:
  test:
    name: Analyze and Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout 🛎️
        uses: actions/checkout@v2

      - name: Setup Flutter 💻
        uses: subosito/flutter-action@v1
        with:
          flutter-version: ${{ env.flutter-version }}

      - name: Cache Pub 💾
        uses: actions/cache@v2
        with:
          path: /opt/hostedtoolcache/flutter/*-stable/x64/.pub-cache
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-

      - name: Run Analyzer and Tests 🧪
        run: |
          flutter pub get
          flutter pub run build_runner build --delete-conflicting-outputs
          flutter analyze
          flutter test --coverage --no-test-assets
          flutter pub run remove_from_coverage -f coverage/lcov.info -r '\.g\.dart$'

      - name: Upload coverage report 📡
        uses: codecov/codecov-action@v1
        with:
          fail_ci_if_error: true

  build-web-deploy:
    name: Build Web and Deploy
    runs-on: ubuntu-latest
    needs: test
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout 🛎️
        uses: actions/checkout@v2

      - name: Setup Flutter 💻
        uses: subosito/flutter-action@v1
        with:
          flutter-version: ${{ env.flutter-version }}

      - name: Cache Pub 💾
        uses: actions/cache@v2
        with:
          path: /opt/hostedtoolcache/flutter/*-stable/x64/.pub-cache
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-

      - name: Build Web App 🔧
        run: |
          flutter pub get
          flutter pub run build_runner build --delete-conflicting-outputs
          flutter build web --dart-define=FLUTTER_WEB_USE_SKIA=true

      - name: Deploy 🚀
        uses: JamesIves/github-pages-deploy-action@4.1.4
        with:
          branch: gh-pages
          folder: build/web
          clean: true

  build-desktop:
    name: Build Desktop
    runs-on: ${{ matrix.os }}
    needs: test
    if: startsWith(github.ref, 'refs/tags/v')

    strategy:
      matrix:
        type: [macos, windows, linux]
        include:
          - type: macos
            os: macos-latest
            pub-path: /Users/runner/hostedtoolcache/flutter/*-stable/x64/.pub-cache
            build-path: build/macos/Build/Products/Release
            build-output: flutter_theme.app

          - type: windows
            os: windows-latest
            pub-path: C:\hostedtoolcache\windows\flutter\*-stable\x64\.pub-cache
            build-path: build\windows\runner
            build-output: Release

          - type: linux
            os: ubuntu-latest
            pub-path: /opt/hostedtoolcache/flutter/*-stable/x64/.pub-cache
            build-path: build/linux/x64/release
            build-output: bundle

    steps:
      - name: Checkout 🛎️
        uses: actions/checkout@v2

      - name: Setup Flutter 💻
        uses: subosito/flutter-action@v1
        with:
          flutter-version: ${{ env.flutter-version }}

      - name: Cache Pub 💾
        uses: actions/cache@v2
        with:
          path: ${{ matrix.pub-path }}
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-

      - name: Patch for Linux Build 🩹
        if: ${{ matrix.type == 'linux' }}
        run: |
          sudo apt-get update -y
          sudo apt-get install -y ninja-build libgtk-3-dev

      - name: Build App 🔧
        run: |
          flutter config --enable-${{ matrix.type }}-desktop
          flutter pub get
          flutter pub run build_runner build --delete-conflicting-outputs
          flutter build ${{ matrix.type }}

      - name: Compress App 🗜️
        run: |
          cd ${{ matrix.build-path }}
          tar -zcvf flutter_theme_${{ matrix.type }}.tar.gz ${{ matrix.build-output }}

      - name: Upload App ⬆️
        uses: actions/upload-artifact@v2
        with:
          path: "**/flutter_theme_${{ matrix.type }}.tar.gz"
          if-no-files-found: error

  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: build-desktop
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Download Artifacts ⬇️
        uses: actions/download-artifact@v2

      - name: Release 🚀
        uses: softprops/action-gh-release@v1
        with:
          files: "**/flutter_theme*.tar.gz"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
