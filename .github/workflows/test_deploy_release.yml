name: GitHub Actions

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:
    inputs:
      release-type:
        description: "Release type"
        required: true

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v2

      - name: Get project Flutter version ğŸ·ï¸
        uses: kuhnroyal/flutter-fvm-config-action@v1

      - name: Setup Flutter ğŸ’»
        uses: subosito/flutter-action@v1.5.3
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}

      - name: Cache Pub ğŸ’¾
        uses: actions/cache@v2
        with:
          path: /opt/hostedtoolcache/flutter/*-stable/x64/.pub-cache
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-

      - name: Run tests ğŸ§ª
        run: |
          flutter pub get
          flutter pub run build_runner build --delete-conflicting-outputs
          flutter test --coverage --no-test-assets --concurrency=4
          flutter pub run remove_from_coverage -f coverage/lcov.info -r '\.g\.dart$' -r 'extensions\.dart'

      - name: Upload coverage report ğŸ“¡
        uses: codecov/codecov-action@v2.1.0

  lint:
    name: Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v2

      - name: Get project Flutter version ğŸ·ï¸
        uses: kuhnroyal/flutter-fvm-config-action@v1

      - name: Setup Flutter ğŸ’»
        uses: subosito/flutter-action@v1.5.3
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}

      - name: Cache Pub ğŸ’¾
        uses: actions/cache@v2
        with:
          path: /opt/hostedtoolcache/flutter/*-stable/x64/.pub-cache
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-

      - name: Run linting ğŸ§ª
        run: |
          flutter pub get
          flutter pub run build_runner build --delete-conflicting-outputs
          flutter analyze

  build-web-deploy:
    name: Build Web and Deploy
    runs-on: ubuntu-latest
    needs: [lint, test]
    if: ${{ github.ref == 'refs/heads/main' }}

    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v2

      - name: Get project Flutter version ğŸ·ï¸
        uses: kuhnroyal/flutter-fvm-config-action@v1

      - name: Setup Flutter ğŸ’»
        uses: subosito/flutter-action@v1.5.3
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}

      - name: Cache Pub ğŸ’¾
        uses: actions/cache@v2
        with:
          path: /opt/hostedtoolcache/flutter/*-stable/x64/.pub-cache
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-

      - name: Build web app ğŸ—
        run: |
          flutter pub get
          flutter pub run build_runner build --delete-conflicting-outputs
          flutter build web --dart-define=FLUTTER_WEB_USE_SKIA=true

      - name: Fix build for GitHub Pages ğŸ”§
        run: |
          REPO_NAME=`echo $GITHUB_REPOSITORY | sed 's/.*\///g'`
          sed -i "s/base\shref=\"\/\"/base href=\"\/$REPO_NAME\/\"/g" \
            build/web/index.html
          sed -i "s/\"\/\",//g" build/web/flutter_service_worker.js

      - name: Deploy ğŸš€
        uses: JamesIves/github-pages-deploy-action@4.1.5
        with:
          branch: gh-pages
          folder: build/web

  build-desktop:
    name: Build Desktop
    runs-on: ${{ matrix.os }}
    needs: [lint, test]
    if: ${{ github.event_name == 'workflow_dispatch' && github.ref == 'refs/heads/main' }}

    strategy:
      matrix:
        type: [macos, windows, linux]
        include:
          - type: macos
            os: macos-latest
            pub-path: /Users/runner/hostedtoolcache/flutter/*-stable/x64/.pub-cache
            build-path: build/macos/Build/Products/Release
            build-output: flutter_theme.app

          - type: windows
            os: windows-latest
            pub-path: C:\hostedtoolcache\windows\flutter\*-stable\x64\.pub-cache
            build-path: build\windows\runner
            build-output: Release

          - type: linux
            os: ubuntu-latest
            pub-path: /opt/hostedtoolcache/flutter/*-stable/x64/.pub-cache
            build-path: build/linux/x64/release
            build-output: bundle

    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v2

      - name: Get project Flutter version ğŸ·ï¸
        uses: kuhnroyal/flutter-fvm-config-action@v1

      - name: Setup Flutter ğŸ’»
        uses: subosito/flutter-action@v1.5.3
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}

      - name: Cache Pub ğŸ’¾
        uses: actions/cache@v2
        with:
          path: ${{ matrix.pub-path }}
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-

      - name: Patch for Linux build ğŸ©¹
        if: ${{ matrix.type == 'linux' }}
        run: |
          sudo apt-get update -y
          sudo apt-get install -y ninja-build libgtk-3-dev

      - name: Build desktop app ğŸ—
        run: |
          flutter config --enable-${{ matrix.type }}-desktop
          flutter pub get
          flutter pub run build_runner build --delete-conflicting-outputs
          # Bump app version, the new version is committed in the release step
          flutter pub run cider bump ${{ github.event.inputs.release-type }}
          flutter build ${{ matrix.type }}

      - name: Compress app ğŸ—œï¸
        run: |
          cd ${{ matrix.build-path }}
          tar -zcvf flutter_theme_${{ matrix.type }}.tar.gz ${{ matrix.build-output }}

      - name: Upload app â¬†ï¸
        uses: actions/upload-artifact@v2
        with:
          path: "**/flutter_theme_${{ matrix.type }}.tar.gz"
          if-no-files-found: error

  release:
    name: Release
    runs-on: ubuntu-latest
    needs: build-desktop

    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT }}

      - name: Get project Flutter version ğŸ·ï¸
        uses: kuhnroyal/flutter-fvm-config-action@v1

      - name: Setup Flutter ğŸ’»
        uses: subosito/flutter-action@v1.5.3
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}

      - name: Cache Pub ğŸ’¾
        uses: actions/cache@v2
        with:
          path: /opt/hostedtoolcache/flutter/*-stable/x64/.pub-cache
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-

      - name: Get previous tag ğŸ·ï¸
        id: previous-tag
        uses: WyriHaximus/github-action-get-previous-tag@v1.1.0

      - name: Bump app version ğŸ”¼
        id: bump-version
        run: |
          flutter pub get
          echo "::set-output name=version::v$(flutter pub run cider bump ${{ github.event.inputs.release-type }})"

      - name: Commit new version ğŸ†•
        uses: stefanzweifel/git-auto-commit-action@v4.12.0
        env:
          version: ${{ steps.bump-version.outputs.version }}
        with:
          commit_message: "chore(release): ${{ env.version }} [skip ci]"
          tagging_message: ${{ env.version }}
          file_pattern: pubspec.yaml
          push_options: --force

      - name: Generate changelog ğŸ“
        id: generate-changelog
        uses: mikepenz/release-changelog-builder-action@v2.7.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          configuration: changelog_config.json
          fromTag: ${{ steps.previous-tag.outputs.tag }}
          toTag: ${{ steps.bump-version.outputs.version }}

      - name: Download artifacts â¬‡ï¸
        uses: actions/download-artifact@v2

      - name: Release ğŸš€
        uses: ncipollo/release-action@v1.8.10
        with:
          tag: ${{ steps.bump-version.outputs.version }}
          artifacts: "**/flutter_theme*.tar.gz"
          body: ${{ steps.generate-changelog.outputs.changelog }}
          token: ${{ secrets.GITHUB_TOKEN }}
